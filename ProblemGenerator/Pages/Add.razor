@using ProblemGenerator.Controllers;
@using ProblemGenerator.Data;
@inject ProblemContext problemContext 
@inject ProblemServices service
@inject NavigationManager NavigationManager
@inject IConfiguration config
@page "/Add"



<PageTitle>Add a problem</PageTitle>





@*<div class="col-5 bg-light m-2 justify-content-start"> *@
     <div class="col-lg-3 col-md-12 mb-4 mb-lg-0" style=" padding: 5px 5px 5px 5px;">
                <div class="card" style="border-color: blue; border-style:solid; border-radius: 5px; border-width: 2px; ">

        <h1 style="padding: 5px 5px 5px 5px;">Add a problem</h1>

    <EditForm Model="@NewProblem" OnValidSubmit="AddNewProblem">
        <DataAnnotationsValidator/>
        
        <div class="form-group" style="padding: 5px 5px 5px 5px;">
            <label for="name">What</label>
            <input type="text" id="what" class="form-control" @bind-value="@NewProblem.What" placeholder="What happened?"/>
            <ValidationMessage For="@(() => NewProblem.What)" />
        </div>

        <div class="form-group" style="padding: 5px 5px 5px 5px;">
            <label for="name">Where</label>
            <input type="text" id="where" class="form-control" @bind-value="@NewProblem.Where" placeholder="Where did it happen?" />
            <ValidationMessage For="@(() => NewProblem.Where)" />
        </div>

        <div class="form-group" style="padding: 5px 5px 5px 5px;">           
            <label for="name">Priority</label>            
                <InputNumber class="form-control" min="1" max="5" @bind-Value="@NewProblem.problemPriority"/>
            <ValidationMessage For="@(() => NewProblem.problemPriority)" />
                    <span class="form-text"> - 1 - least important</span>
        </div>


        <div class="form-group" style="padding: 5px 5px 5px 5px;">
            <label for="name">Detailed description</label>
            <InputTextArea class="form-control" @bind-Value="@NewProblem.DetailedDescription" placeholder="Place for any additional details." />
            <ValidationMessage For="@(() => NewProblem.DetailedDescription)" />

        </div>

        <div class="form-group" style="padding: 5px 5px 5px 5px;">
            <label>Problem picture:</label>
            <InputFile OnChange="@LoadFiles" class="form-control" multiple accept=".png,.jpg,.jpeg" />
        </div>
        

        <div class="text-center p-3 mb-3">
            @* <button class="btn btn-info" @onclick="AddNewProblem" > Add Problem</button>*@
            <button class="btn btn-info" type="submit">Add problem</button>
            <ValidationSummary />
        </div>
        
    </EditForm>
    
</div>
</div>



@code {
    private long maxFileSize = 1024 * 1024 * 3; //3 MB
    private IBrowserFile? file;
    private List<string> errors = new();

    List<Problem> Problems = new List<Problem>();
    protected override async Task OnInitializedAsync()
    {
        await RefreshProblems();
    }

    private async Task RefreshProblems()
    {
        Problems = await service.GetProblemsAsync();
    }

    public Problem NewProblem { get; set; } = new Problem();



    private async Task AddNewProblem()
    {
        NewProblem.DateCreated = DateTime.Now;
        string relativePath = await CaptureFile();
        //NewProblem.ImgPath = relativePath;
        //string path = await CaptureFile();
        //NewProblem.ImgPath = path;
        NewProblem.ImgPath = Path.Combine(config.GetValue<string>("WebStorageRoot")!, relativePath);

        await service.AddNewProblem(NewProblem);
        NewProblem = new Problem();

        await RefreshProblems();
        NavigationManager.NavigateTo("/", true);
    }

    Problem UpdateProblem = new Problem();
    private void SetProblemForUpdate(Problem problem)
    {
        UpdateProblem = problem;
    }

    private async Task UpdateProblemData()
    {
        await service.UpdateProblemAsync(UpdateProblem);
        await RefreshProblems();
    }

    private async Task DeleteProblem(Problem problem)
    {
        await service.DeleteProblemAsync(problem);
        await RefreshProblems();
    }


    private void LoadFiles(InputFileChangeEventArgs e)
    {
        file = e.File;
    }

    private async Task<string> CaptureFile()
    {
        if (file is null)
        {
            return "";
        }



        try
        {
            string newFileName = Path.ChangeExtension(Path.GetRandomFileName(), Path.GetExtension(file.Name));
            string path = Path.Combine(config.GetValue<string>("FileStorage")!, $"{DateTime.Today.ToString("d")}", newFileName);
            string relativePath = Path.Combine($"{DateTime.Today.ToString("d")}", newFileName);
            Directory.CreateDirectory(Path.Combine(config.GetValue<string>("FileStorage")!, $"{DateTime.Today.ToString("d")}"));

                        await using FileStream fs = new(path, FileMode.Create);
            await file.OpenReadStream(maxFileSize).CopyToAsync(fs);

            return relativePath;
            
        }
        catch (Exception ex)
        {

            errors.Add($"File: {file.Name} Error: {ex.Message}");
            throw;
        }

    }
    

}
